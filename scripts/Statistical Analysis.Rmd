---
title: "Statistical Analysis"
author: "Lyttia Cancinos-McManus"
date: "September 2, 2018"
output: html_document
---

0. Load Packages:
```{r}
library(ggplot2)
library(tidyverse)
```
  
0a. Load Data:
```{r}
crimes <- file.choose()
crimes <- read_csv(crimes)
str(crimes)
# parsing corrections:
crimes$monthRC <- factor(x = crimes$month, 
                       labels = c("Jan", "Feb", "Mar", "Apr", "May", "Jun",
                                  "Jul" ,"Aug" ,"Sep" , "Oct", "Nov", "Dec"),
                       ordered = T)
crimes <- crimes %>% 
  mutate_if(is.character, as.factor)
str(crimes)
```

1. Counts:

_Counting Zipcodes_
*2 methods to count and show zipcodes being analyzed* 
```{r}
all_zipcodes <- crimes %>% distinct(zipcode) 
View(all_zipcodes)

crimes %>% group_by(zipcode) %>% summarise()
```
*Using 43 zipcodes total for analysis out of orig 102 from phx crime data*

_Counting crimes per zip-code_
*to return a count of the number of crimes reported in each zip-code*
```{r}
crime_count_by_zip <- crimes %>% 
  count(zipcode)
crime_count_by_zip
```

_Exploratory Ordered Count_
*Zipcodes ordered from highest crime count to lowest.*
```{r}
zipcodes <- table(crimes$zipcode)
ordered_zipcodes <- order(zipcodes, decreasing = TRUE)
ordered_zipcodes
barplot(zipcodes[order(zipcodes, decreasing = TRUE)]) 
```
_Descriptive Plot: ggplot_
```{r}
g1.5 <- ggplot(crimes, aes(zipcode))
g1.5 + geom_bar(aes(fill=category), width = 0.5) + 
  theme(axis.text.x= element_text(angle = 65, vjust= 0.6)) + 
  labs(title= "Zipcode Frequency Bar Chart")
#ggsave("Zipcode Frequency Bar Chart- PHX zips only.png")
```

_Counting crime per month_
*Number of crimes each month in 2017 and 2016.* 
```{r}
crimes2017 <- crimes %>% filter(year == 2017)
crimes2016 <- crimes %>% filter(year == 2016)
crimes2017 %>% count(month)
crimes2016 %>% count(month)
months2017RC <- table(crimes2017$monthRC)
months2017 <- table(crimes2017$month)
months2016RC <- table(crimes2016$monthRC)
months2016 <- table(crimes2016$month)
barplot(months2017)
barplot(months2016)
barplot(months2017RC[order(months2017RC, decreasing = TRUE)])
barplot(months2016RC[order(months2016RC, decreasing = TRUE)])

# Tally by month the dplyr way
group_by(crimes2017, monthRC) %>%
    summarise(count = n()) %>%
    arrange(desc(count))

group_by(crimes2016, monthRC) %>%
    summarise(count = n()) %>%
    arrange(desc(count))
```

```{r}
g <- ggplot(crimes2016, aes(zipcode, decreasing = TRUE))
g + geom_bar(aes(fill=category), width = 0.5) + 
  theme(axis.text.x= element_text(angle = 65, vjust= 0.6)) + 
  labs(title= "2016 Zipcode Frequency Bar Chart")
ggsave("2016 Zipcode Frequency Bar Chart.png")
```


*to return the count of the number of crimes reported each month in the highest crime zip (85015) in 2016*
```{r}
phx15_16n <- crimes %>% 
  filter(zipcode == 85015 & year == 2016) %>% 
  count(monthRC)

phx15_16n
#graph it!
```

*to return the count of the number of crimes reported each month in the highest crime zip (85015) in 2016*
```{r}
phx15_17n <- crimes %>% 
  filter(zipcode == 85015 & year == 2017) %>% 
  count(monthRC)

phx15_17n
#graph it!
```

# Frequency of Burglary by zipcode (in descending order)

```{r}
df <- crimes %>% 
  filter(category == "Burglary") %>% 
  group_by(zipcode) %>%
  summarise(n = n()) %>%
  ungroup() %>%
  arrange(desc(n))
```

# Using ggplot2

```{r}
ggplot(df, aes(x = reorder(zipcode, n), y = n)) + 
  geom_point(size = 12, stat = "identity", color = "black") + 
  geom_text(aes(label = n, fontface = "bold"), color = "white", size = 4) + 
  coord_flip() + 
  theme_minimal(base_size = 20) + 
  xlab("") + ylab("") + 
  ggtitle("Burglary offences in Greater Phoenix") +
  scale_y_continuous(limits=c(0,max(df$n)))
```

# Save the dotplot as a png file

```{r}
ggsave("dotplot.png", scale = 2, dpi = 300)
```

Total number of each category of crime. 
```{r}
crime_count_by_category <- crimes %>% count(category)
crime_count_by_category
categories <- table(crimes4$category)
ordered_categories <- categories[order(categories, decreasing = TRUE)]
barplot(ordered_categories)
```

Total number of each category of crime in zip code with highest crime count. 
```{r}
crimes85015 <- crimes %>% filter(zipcode == 85015)
crimes85015 %>% count(category)
categories85015 <- table(crimes85015$category)
barplot(categories85015[order(categories85015, decreasing = TRUE)])
```

2. Trends (high, low, increase, decrease, anomalies):

Zip code 85015 has the highest crime count total at almost 9000 crimes (8965).

Multiple zip codes have only 1 crime 

Crime count seems to be between 5,000-5,500 each month.

2.Bar Plots

  + Ordered Zip Count

*make a zipcode table*

```{r}
zipcodetbl <- table(crimes$zipcode)
```

*order zipcode table*

```{r}
ordered_zipcodes <- order(zipcodetbl, decreasing = TRUE)
```

*make barplot with zipcode table*

```{r}
barplot(zipcodetbl[ordered_zipcodes])
```

*arranges data by premise type count*

```{r}
ordered_premise <-  crimes %>% 
  group_by(premise)%>% 
  mutate(n=n()) %>% 
  ungroup() %>% 
  arrange(-n)

ordered_premise
```

```{r}
head(crime_count_by_premise)

g <- ggplot(crimes, aes(premise, decreasing = TRUE))
g + geom_bar(aes(fill=category), width = 0.5) + 
  theme(axis.text.x= element_text(angle = 65, vjust= 0.6)) + 
  labs(title= "Premise Frequency Bar Chart")

ggsave("Premise Frequency Bar Chart.png")

#make table to order for ordered bar plot

premise_table <- table(crimes_joined$premise)
ordered_premise <- order(premise_table, decreasing = TRUE)
head(ordered_premise)
barplot(premise_table[ordered_premise])

```

3. Bar plot/ histogram:
```{r}
# install.packages("ggplot2")
library(ggplot2)
#-----------------Setup Theme--------------------------------------------------
my_theme <- theme_bw() +
    theme(panel.border = element_blank(),
          axis.ticks = element_blank(),
          panel.grid.minor = element_blank(),
          panel.grid.major.x = element_blank(),
          panel.grid.major.y = element_line(size = 0.5),
          axis.title = element_text(colour = "grey40"),
          plot.title = element_text(vjust = 2.0))

#-----------------Total Crimes by Month 2017 (order alpha)---------------------
ggplot(data = crimes2017, aes(x = monthRC)) + 
    my_theme +
    geom_bar(stat = "count", fill = "lightblue", width = 0.75) +
    ggtitle("Crimes reported to Phoenix PD each Month in 2017") +
    xlab("Month (alpha order)") +
    ylab("Crime Count")

#----------------Total Crimes by Month 2017 (order decr)-----------------------
orderedmonths <- dplyr::count(crimes2017, monthRC) %>% 
  arrange(-n) %>% 
  mutate(monthRC = factor(monthRC, monthRC)) 
orderedmonths_list <- c("Oct", "Aug", "Jul", "May", "Jan", "Jun", "Dec", "Mar", "Nov", "Apr", "Sep", "Feb")
  
ggplot(crimes2017, aes(x = monthRC)) + 
  geom_bar(stat = "count", fill = "lightblue", width = 0.75) + 
  scale_x_discrete (limits = orderedmonths_list) +
  geom_text(stat = "count", aes(label=..count..), vjust=-0.5) +
  my_theme +
  ggtitle("Crimes reported to Phoenix PD each Month in 2017") +
  xlab("Month (ordered by crime count)") +
  ylab("Crime Count")

ggsave("crime_count_by_month2017.png")

#----------------Total Crimes by Month 2016 (order decr)-----------------------
orderedmonths2016 <- dplyr::count(crimes2016, monthRC) %>% 
  arrange(-n) %>% 
  mutate(monthRC = factor(monthRC, monthRC)) 
orderedmonths2016_list <- c("Dec", "Aug", "Oct", "Jan", "Nov", "Apr", "Jun", "Sep", "May", "Jul", "Mar", "Feb")
  
ggplot(crimes2016, aes(x = monthRC)) + 
  geom_bar(stat = "count", fill = "lightblue", width = 0.75) + 
  scale_x_discrete (limits = orderedmonths2016_list) +
  geom_text(stat = "count", aes(label=..count..), vjust=-0.5) +
  my_theme +
  ggtitle("Crimes reported to Phoenix PD each Month in 2016") +
  xlab("Month (ordered by crime count)") +
  ylab("Crime Count")

ggsave("crime_count_by_month2016.png")
```

Are any categories more prevelant at a certain time?

```{r}
crimes2017$category <- factor(x = crimes2017$category)
crimes2017$category <- reorder(x = crimes2017$category, X = crimes2017$category, FUN = length)

# Tally by type
table(crimes2017$category)[order(table(crimes2017$category), decreasing = T)] # Order decreasing

# Subset the data for the less frequent categories
sub <- levels(crimes2017$category)[1:4] # Create a subsetting object
temp <- filter(crimes2017, sub %in% category) # Subset using dplyr
View(temp)

# Make plot
ggplot(data = temp, aes(x = monthRC, color = category, group = category)) +
    my_theme +
    geom_line(stat = "bin", size = 1) +
    ggtitle("Crimes by Month - Less Frequent Categories") +
    xlab(NULL) +
    ylab("Crime Count")

# Do another subset for the more frequent categories
sub <- levels()[5:7]
temp <- filter(crimes2017, category %in% sub)

# Make second plot
ggplot(data = temp, aes(x = monthRC, color = category, group = category)) + 
    my_theme +
    geom_line(stat = "bin", size = 1) +
    ggtitle("Crimes by Month - More Frequent Categories") +
    xlab(NULL) +
    ylab("Crime Count")
```

Does overall crime count increase or decrease as property values increase?
Property values need to be binned. 

```{r}
lowermiddlehousing = subset(crimes4, median_value < 500000)
middlehousing = subset(lowermiddlehousing, median_value >= 250000)
lowincomehousing = subset(crimes4, median_value < 250000)
upperhousing = subset(crimes4, median_value >= 500000)

plot(count(lowincomehousing, median_value), lowincomehousing$median_value)
plot(count(middlehousing, median_value), middlehousing$median_value)
plot(count(upperhousing, median_value), upperhousing$median_value)

reg()

ccountupperhousing <- count(upperhousing, median_value)
upperhousing2 <- left_join(upperhousing, ccountupperhousing)


```

4. Comparisons:
Compare the amounts of crimes in each zip code ordered by property value.

```{r}
barplot(zipcodes[order(crimes4$median_value, decreasing = TRUE)])

```

Scatterplots:

```{r}
# install.packages("ggplot2")
# load package and data
options(scipen=999)  # turn-off scientific notation like 1e+48
library(ggplot2)
theme_set(theme_bw())  # pre-set the bw theme.

# Scatterplot
gg <- ggplot(upperhousing2, aes(x = as.numeric(median_value), y = n)) + 
  geom_point(aes(col = category)) + 
  labs(subtitle="Scatterplot", 
       y="Crime Count", 
       x="Property Value", 
       title="Crime Count by Property Value", 
       caption = "Source: Phoenix Open Data")

plot(gg)
ggsave("crime_count_by_property_value_upper.png")
```

5. Can you make a time-series plot?

```{r}
install.packages("plotly")
library(plyr)
library(dplyr)
library(plotly)

crimes2016_2017 <- filter(crimes4, year %in% c("2016","2017"))
View(crimes2016_2017)

total_crime_2years <-
  crimes2016_2017 %>% 
  mutate(year = as.integer(as.character(year))) %>%
  group_by(crime.type, year) %>% 
  dplyr::summarize(reported_incidents = n())

trend_plot <- 
  ggplot(data = total_crime_2years,
       aes(x = year, y = reported_incidents, fill = crime.type)) +
  geom_area() +
  ggtitle("Violent vs. Non-Violent Crimes in 2016-2017") +
  scale_y_continuous(name = "Reported Incidents", labels = scales::comma) +
  my_theme

ggplotly(trend_plot)

```


```{r} 
# NOT WORKING
# Subset the data for the less frequent categories
sub <- levels(ordered_categories)[1:4] # Create a subseting object
temp <- filter(crimes4, category %in% sub) # Subset using dplyr

# Make plot
ggplot(temp, aes(x = monthRC, color = category, group = category)) +
    my_theme +
    geom_line(stat = "bin", size = 1) +
    ggtitle("Crimes by Month - Less Frequent Categories") +
    xlab(NULL) +
    ylab("Crime Count")

# Do another subset for the more frequent categories
sub <- levels(ordered_categories)[5:7]
temp <- filter(crimes4, category %in% sub)

# Make second plot
ggplot(temp, aes(x = monthRC, color = category, group = category)) + 
    my_theme +
    geom_line(stat = "bin", size = 1) +
    ggtitle("Crime by Month - More Frequent Categories") +
    xlab(NULL) +
    ylab("Crime Count")
```

6.Having made these plots, what are some insights you get from them? Do you see any correlations? Is there a hypothesis you would like to investigate further? What other questions do they lead you to ask?

Limitations: 
Accounts only for crimes reported to Phoenix PD. There may be many other crimes reported to surrounding PDs. Would my model be more accurate if I only included zip codes located within Phoenix boundaries?

